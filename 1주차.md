## 1주차 목표
> 자바 소스 파일(.java)을 JVM으로 실행하는 과정 이해하기




## 학습할 것
    - JVM이란 무엇인가
    - 컴파일 하는 방법
    - 실행하는 방법
    - 바이트코드란 무엇인가
    - JIT 컴파일러란 무엇이며 어떻게 동작하는지
    - JVM 구성 요소
    - JDK와 JRE의 차이



### 개인 목표
> 아무것도 모르는 일반인이 이해할 수 있도록 쉽게 설명해보기




## JVM이란 무엇인가

Java Virtual Machine 줄여서 JVM이라고 부르며, 한국어로 번역하자면 `자바 가상 머신`으로 불린다.



`JVM의 목적`

자바 프로그램이 어디에서든 실행 될 수 있도록 도와주기위해 생겨났다.(핸드폰, 컴퓨터, 윈도우, 리눅스... 모든 곳!)

어떤 컴퓨터에서든 그냥 원래 자바로 할 수 있는 것이 아닐까??? 이렇게 생각 할 수 있지만, 옛날 프로그램들은 각 운영체제에 맞춰 프로그램은 작성되었었다.  
`남붕어가 혁신적인 계산기 프로그램을 만들어서 윈도우에 프로그램을 적용하여도, 리눅스, OSX 등 수많은 운영체계를 사용하는 컴퓨터들은 남붕어 계산기를 사용할 수 없다는 뜻이다.`  
그럼 똑같은 프로그램을 수없이 만들어야하는 굉장히 고된 작업이 될 것이다.


또한 스스로 프로그램 메모리를 관리하고 최적화하는 기능도 있기에, 프로그램 메모리를 따로 관리 할 수고를 줄여준다.





## 컴파일 하는 방법

컴파일(Compile)이란 `프로그래밍 언어로 만든 프로그램을 실제 컴퓨터에서 컴퓨터가 쓰는 언어로 번역`하는 것이다.  
다시말하자면 우리가 배우는 언어(자바, 파이썬, C, C++ 등)는 컴퓨터가 쓰는 언어(예시로 한국어라고 하자)랑은 다르다는 것이다.  
자바 나라에 사는 남붕어가 한국에 사는 남소연에게 자신이 쓰는 자바어로 이야기해도 한국어를 아는 남소연은 모르는 것과 똑같다.  

그럼 자바와 컴퓨터는 어떻게 이야기를 나눌 수 있을까?  

1. 자바는 `.java`라는 언어를 사용하며, 이는 컴퓨터가 읽을 수가 없다.  
2. 자바 컴파일러 `javac`는 자바와 컴퓨터의 1차 통역가로, `.java` 언어를 `.class` 언어로 바꿔준다.  
3. 2차 통역가 `JVM`은 `Interpreter`나 `JIT Compiler`로 `.class`언어를 해석해서 컴퓨터에게 알려준다.

![99B7443D5C29F7A107](https://user-images.githubusercontent.com/67003390/99931190-f7c29180-2d96-11eb-85d9-2e0e3396204b.png)

그림 참조 : https://yoonemong.tistory.com/183



## 실행하는 방법

1. .java 파일을 생성한다.  
2. 생성한 .java 파일을 컴파일한다.  
3. .class 파일이 생긴다.  

컴파일 부분을 이해하셨다면, 이부분은 복습이라고 생각하면 좋을 것 같습니다.  


그 뒤 class 안에 main 메소드를 찾아서 그 안에 개발자가 지시한 내용을 순차적으로 실행해 나갑니다.



## 바이트코드란 무엇인가

자바 가상 머신(JVM)이 가장 처음에 가지고있는 모국어라고 생각하면 됩니다.  
한글에 ㄱ,ㄴ,ㄷ,ㄹ...처럼 언어의 가장 작은 단위가 있듯이, JVM이 가지고있는 언어의 크기는 `1바이트`라서 바이트코드라고 불립니다.  
자바 바이트 코드의 확장자는 컴퓨터에게 해석해서 알려주는 확장자 `.class`를 씁니다.




## JIT 컴파일러란 무엇이며 어떻게 동작하는지


![캡처](https://user-images.githubusercontent.com/67003390/99932048-21c98300-2d9a-11eb-909e-1c35dfe8d418.PNG)
알게모르게 우리는 jit 컴파일러를 이미 한 번 보았습니다.  

JVM은 두 가지의 방법으로 컴퓨터에게 언어를 해석해 준다고 앞서 이야기했습니다.  

두 방법은 하려는 일은 똑같으나 서로 잘하는 분야가 다릅니다.  


##### Interpreter

`남붕어는 시장에서 사과를 1개 샀다.  
남붕어는 다시 시장에 가서 우유를 하나 샀다.`

위의 글을 읽을 때 우리는 자연스럽게 문장 전체를 읽는 것이 아니라 사실 자음 모음 하나하나를 조합해서 단어를 만들고, 단어가 모여서 글이 이루어집니다.
다시 말하자면 `ㄴ ㅏ ㅁ ㅂ ㅜ ㅇ ㅇ ㅓ ㄴ ㅡ ㄴ` 자음 모음을 붙여가며 `남 붕 어`로 만들고 이 과정을 마침표가 있는 지점까지 반복하여 하나의 글을 만들어,  
`남붕어는 시장에서 사과를 1개 샀다`라는 글을 이해하게 됩니다.  


자바의 한글 자음모음에 해당하는 바이트코드는 위와 똑같은 방법으로 한 줄 씩 읽어나가면서 주어진 명령을 수행합니다.  
  
    
> 자바의 Interpreter식 생각  

`남붕어는 시장에서 사과를 1개 샀다.`  
아 그럼 사과를 1개 사야겠다.  
`집에 오던 남붕어는 우유를 안산 것을 확인하고 다시 시장에 가서 우유를 하나 샀다.`  
어? 우유도 사야해? 그럼 다시 남붕어를 시장으로 보내고, 우유를 사게 해야겠네.  
  
  
위와 같은 방법으로 한 줄씩 주어진 내용을 수행하는 방법은 매번 같은 행동을 반복하면, 그때마다 한 줄씩 읽고 해석해야 하기때문에 시간이 오래걸립니다.  
> 따라서 반복하지않는 일을 할 때에는 Interpreter 방식을 사용하는 것이 좋습니다.



##### JIT Compiler

`남붕어는 3일에 한 번 씩 시장에서 사과와 우유를 산다.  
그 뒤 베라에 가서 민트초코 아이스크림을 한 통 산다.  
장을 다 본 남붕어는 집으로 갈 때 17번 버스를 타고 집으로 간다.`  

Interpreter와 동일한 방법으로 읽어나가는 것은 똑같습니다.  

    
> 자바의 JIT Compiler 생각  

`남붕어는 3일마다 시장에서 사과와 우유를 사는구나.
그리고 베라에 가서 민트초코 아이스크림 한 통을 사게 하자,
집에 올 땐 17번 버스를 타라고 다음에 또 같은 일을 시키면 이렇게하면 되겠다.`  
  
  
3일 뒤 똑같은 내용을 받은 자바...
  
  
`남붕어 시장가서 사과와 우유를 사고, 베라 들러서 민트초코 아이스크림 한 통 사고, 17번 버스 타고 집 와.`      
  
  
Interpreter와 차이점이 보이나요?  
Interpreter는 매번 똑같은 내용이더라도 새롭게 읽어나가지만, JIT Compiler는 처음보는 내용이 있으면 그 내용을 똑같이 읽고는 자신의 메모장에 기록을 해둡니다.  
그리고 다음에 똑같은 일을 시키면 다음부턴 빠르게 수행을 할 수 있는 능력을 가지고 있습니다.  
  
  
  
  
## JVM 구성 요소


우리는 지금까지 JVM이 무엇인지부터 JVM이 무슨 언어를 쓰는지까지 알아보았으니, 이제 무엇으로 이루어져있는지 알아보자.  

![2753604F5703E1D11E](https://user-images.githubusercontent.com/67003390/99948278-94e3f100-2dbc-11eb-8328-31ce7041f456.png)  
[그림출처] https://odol87.tistory.com/5


크게 3분류로 나뉘어진 것을 확인할 수 있다.  


1. class loader  
  
class 파일이 들어오면, JVM은 `class loader`가 들어온 내용을 읽는다.  
조금 어려운 말로는 `동적 로드`를 담당하는 역할을 맡고있다.  


2. runtime data areas  

JVM의 메모리 영역으로 런타임 데이터 영역 안에는 더 세부적으로 여러가지가 있습니다.  
크게는 자바가 막히지않고 데이터가 원활하게 돌아갈 수 있도록 해주는 역할로 알면 됩니다.  


자세한 내용을 원하는 분들을 위해 잘 설명을 해놓은 글을 가져왔으니 참고해주세요.  
출처로 들어가시면 더 많은 내용을 보실 수 있습니다.  

- `PC 레지스터`: PC(Program Counter) 레지스터는 각 스레드마다 하나씩 존재하며 스레드가 시작될 때 생성된다. PC 레지스터는 현재 수행 중인 JVM 명령의 주소를 갖는다.  
- `JVM 스택`: JVM 스택은 각 스레드마다 하나씩 존재하며 스레드가 시작될 때 생성된다. 스택 프레임(Stack Frame)이라는 구조체를 저장하는 스택으로, JVM은 오직 JVM 스택에 스택 프레임을 추가하고(push) 제거하는(pop) 동작만 수행한다. 예외 발생 시 printStackTrace() 등의 메서드로 보여주는 Stack Trace의 각 라인은 하나의 스택 프레임을 표현한다. 
- `스택 프레임` : JVM 내에서 메서드가 수행될 때마다 하나의 스택 프레임이 생성되어 해당 스레드의 JVM 스택에 추가되고 메서드가 종료되면 스택 프레임이 제거된다. 각 스택 프레임은 지역 변수 배열(Local Variable Array), 피연산자 스택(Operand Stack), 현재 실행 중인 메서드가 속한 클래스의 런타임 상수 풀에 대한 레퍼런스를 갖는다. 지역 변수 배열, 피연산자 스택의 크기는 컴파일 시에 결정되기 때문에 스택 프레임의 크기도 메서드에 따라 크기가 고정된다.  
- `지역 변수 배열` : 0부터 시작하는 인덱스를 가진 배열이다. 0은 메서드가 속한 클래스 인스턴스의 this 레퍼런스이고, 1부터는 메서드에 전달된 파라미터들이 저장되며, 메서드 파라미터 이후에는 메서드의 지역 변수들이 저장된다.  
- `피연산자 스택` : 메서드의 실제 작업 공간이다. 각 메서드는 피연산자 스택과 지역 변수 배열 사이에서 데이터를 교환하고, 다른 메서드 호출 결과를 추가하거나(push) 꺼낸다(pop). 피연산자 스택 공간이 얼마나 필요한지는 컴파일할 때 결정할 수 있으므로, 피연산자 스택의 크기도 컴파일 시에 결정된다.  
- `네이티브 메서드 스택` : 자바 외의 언어로 작성된 네이티브 코드를 위한 스택이다. 즉, JNI(Java Native Interface)를 통해 호출하는 C/C++ 등의 코드를 수행하기 위한 스택으로, 언어에 맞게 C 스택이나 C++ 스택이 생성된다.  
- `메서드 영역` : 메서드 영역은 모든 스레드가 공유하는 영역으로 JVM이 시작될 때 생성된다. JVM이 읽어 들인 각각의 클래스와 인터페이스에 대한 런타임 상수 풀, 필드와 메서드 정보, Static 변수, 메서드의 바이트코드 등을 보관한다. 메서드 영역은 JVM 벤더마다 다양한 형태로 구현할 수 있으며, 오라클 핫스팟 JVM(HotSpot JVM)에서는 흔히 Permanent Area, 혹은 Permanent Generation(PermGen)이라고 불린다. 메서드 영역에 대한 가비지 컬렉션은 JVM 벤더의 선택 사항이다.  
- `런타임 상수 풀` : 클래스 파일 포맷에서 constant_pool 테이블에 해당하는 영역이다. 메서드 영역에 포함되는 영역이긴 하지만, JVM 동작에서 가장 핵심적인 역할을 수행하는 곳이기 때문에 JVM 명세에서도 따로 중요하게 기술한다. 각 클래스와 인터페이스의 상수뿐만 아니라, 메서드와 필드에 대한 모든 레퍼런스까지 담고 있는 테이블이다. 즉, 어떤 메서드나 필드를 참조할 때 JVM은 런타임 상수 풀을 통해 해당 메서드나 필드의 실제 메모리상 주소를 찾아서 참조한다.  
- `힙` : 인스턴스 또는 객체를 저장하는 공간으로 가비지 컬렉션 대상이다. JVM 성능 등의 이슈에서 가장 많이 언급되는 공간이다. 힙 구성 방식이나 가비지 컬렉션 방법 등은 JVM 벤더의 재량이다.  

출처: https://odol87.tistory.com/5 [IT 인생]

  
3. exectuion engine  
  
엔진 뜻 답게 바이트코드를 실행해주는 역할을 한다.  


- 인터프리터 : 바이트코드 명령어를 하나씩 읽어 해석하고 실행한다. 하나씩 해석하고 실행하기 때문에 바이트코드 하나하나의 해석은 빠르나 결과의 실행은 느리다는 단점이 있다. 바이트코드라는 언어는 기본적으로 인터프리터 방식으로 동작한다.  
- JIT(Just In Time) 컴파일러 : 인터프리터 방식의 단점을 보완하기 위해 도입된 것이다. 인터프리터 방식으로 실행하다가 적절한(?) 시점에 바이트코드 전체를 컴파일하여 네이티브 코드로 변경하여 캐시에 저장한 후 직접 실행하는 방식이다.  

출처: https://odol87.tistory.com/5 [IT 인생]  




## JDK와 JRE의 차이  


JVM이 이제 자바 가상머신으로 자바를 어디에서든 사용할 수 있게 만들어주는 언어통역기라는 것을 알았다.  
그렇다면 JDK와 JRE는 무엇일까?  

JRE는 자바 실행환경(Java Runtime Environment)으로 JVM이 자바 프로그램을 실행할 때 필요한 파일들을 가지고 있는 프로그램이다.  
JRE가 JVM을 포함한 좀 더 큰 범위라고 생각하면 편할 것 같다.  

JDK는 자바 개발도구(Java Development Kit)로 프로그램을 개발하기 위한 도구까지 포함 된 프로그램이다.  
따라서, JDK에 JRE와 JVM이 같이 들어있어서 우리가 쉽게 이클립스를 다운받아서 코딩을 할 수 있는 것이다.  

![2](https://user-images.githubusercontent.com/67003390/99959250-ff515d00-2dcd-11eb-9c91-45694fd6e135.jpg)  
[출처] https://wikidocs.net/257
